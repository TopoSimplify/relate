package homotopy

import (
	"time"
	"testing"
	"simplex/ctx"
	"github.com/intdxdt/geom"
	"github.com/franela/goblin"
)

func loads(wkt string) []*geom.Point {
	return geom.NewLineStringFromWKT(wkt).Coordinates()
}

//func printChain(chain *Chain) {
//	var coords []*geom.Point
//	var link = chain.link
//	for link != nil {
//		coords = append(coords, link.Point)
//		link = link.next
//	}
//	fmt.Println(geom.NewLineString(coords).WKT())
//}

func TestHomotopyDeformation(t *testing.T) {
	g := goblin.Goblin(t)
	g.Describe("context homotopy", func() {

		g.It("should test chain deformation - case 1", func() {
			g.Timeout(1 * time.Hour)

			var contexts = contextGeoms([]string{
				"POINT ( 558.8093849954861 63.948006631233056 )",
				"POINT ( 860.6976575984221 -35.93367827534772 )",
				"POINT ( 1258.198878194574 37.076749997414886 )",
				"POINT ( 1313.3623128895501 -29.443862428879928 )",
			})
			var wkt = "LINESTRING ( 600 0, 600 100, 500 100, 500 -100, 400 100, 600 200, 900 300, 1200 200, 1400 100, 1400 1.7158013051015217, 1400 -100, 1336.2430712729156 -100, 1332.8103356508254 97.83239872362749, 1200 100, 1200 -100, 1236.6937382322994 -87.53532486924402, 1226.3955313660288 72.08688155795089, 1291.6175081857427 66.93777812481557, 1278.0572495001297 -101.81210774059059, 1000 -300, 739.3977399886022 -182.83688839549262, 739.3977399886022 117.16311160450738, 839.3977399886022 117.16311160450738, 841.9291416919249 -102.98263516864998, 883.251804604375 -40.347537079926326, 884.4792054022216 117.8277156849893, 939.3977399886022 117.16311160450738, 939.762106921496 -102.98263516864998, 1039.3114399621122 -102.98263516864998, 1099.384313348691 -48.05886521520657, 1099.6824840778606 5.139171483985346 )"
			var ch = chainDeformation(loads(wkt), contexts)
			g.Assert(ch.size).Equal(4)
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//--

			contexts = contextGeoms([]string{
				"POLYGON (( 332.4204965563913 201.64833221861224, 332.4204965563913 235.93798442335282, 344.1291582848393 235.93798442335282, 344.1291582848393 201.64833221861224, 332.4204965563913 201.64833221861224 ))",
			})
			wkt = "LINESTRING ( 100 239, 100 400, 500 400, 700 200, 200 100, 200 300, 255 300, 256 166, 290 165, 287 301, 326 299, 321 175, 356 174, 356 299, 500 300, 600 200, 400 200, 400 275, 426 275, 429 221, 445 222, 445 272, 461 274, 462 224, 496 227, 495 257 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//--

			contexts = contextGeoms([]string{
				"POLYGON (( 2039.6431464525006 -2800, 2039.6431464525006 -2612.4090716829337, 2200 -2612.4090716829337, 2200 -2800, 2039.6431464525006 -2800 ))",
				"POLYGON (( 2846.808051525009 -2764.535239139212, 2846.808051525009 -2600, 2964.1021640714234 -2600, 2964.1021640714234 -2764.535239139212, 2846.808051525009 -2764.535239139212 ))",
			})
			wkt = "LINESTRING ( 1500 -2500, 1502.4236784626214 -2300, 1700 -2300, 1700 -2700, 1200 -2700, 1198.6665502047617 -2100, 1900 -2100, 1900 -2900, 1000 -2900, 1000 -2000, 2300 -2000, 2283.1263244603597 -2858.0908336743546, 2483.1263244603597 -2858.0908336743546, 2483.1263244603597 -2058.0908336743546, 2583.1263244603597 -2058.0908336743546, 2583.1263244603597 -2858.0908336743546, 2783.1263244603597 -2858.0908336743546, 2800 -1900, 3700 -1900, 3700 -2900, 3000 -2900, 3000 -2100, 3500 -2100, 3500 -2700, 3200 -2700, 3200 -2300, 3400 -2300, 3400 -2500 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//--

			contexts = contextGeoms([]string{
				"POLYGON (( 300 -1200, 300 -1100, 400 -1100, 400 -1200, 300 -1200 ))",
			})

			wkt = "LINESTRING ( 300 -1000, 300 -798.933215074757, 300 -600, 600 -500, 1000 -500, 1200 -600, 1400 -700, 1600 -1000, 1600 -1200, 1400 -1200, 1400 -1000, 1200 -800, 1000 -700, 700 -700, 600 -700, 600 -1000, 500 -1200, 400 -1300, 200 -1300, 100 -1100, 100 -800, -100 -800, -100 -1200, 200 -1500, 600 -1500, 800 -1300, 800 -1000 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			contexts = contextGeoms([]string{
				"POLYGON (( 4600 -1100, 4600 -900, 4700 -900, 4700 -1100, 4600 -1100 ))",
			})
			wkt = "LINESTRING ( 2100 -1200, 2400 -1700, 2700 -1900, 3100 -2100, 3700 -2200, 4300 -2100, 4800 -1700, 5000 -1400, 5000 -1100, 5000 -900, 4700 -700, 4400 -700, 4300 -900, 4200 -1100, 4300 -1400, 4000 -1700, 3600 -1400, 3600 -1100, 3800 -900, 3800 -700, 3600 -500, 3200 -600, 3100 -900, 3100 -1200, 3100 -1600, 2800 -1600, 2600 -1400, 2500 -1000, 2600 -600, 2800 -300, 3200 -100, 3900 0, 4452.457844881692 -45.940163083620405, 5100 -200, 5400 -600, 5400 -1200 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//--

			contexts = contextGeoms([]string{
				"POLYGON (( 4600 -1100, 4600 -900, 4700 -900, 4700 -1100, 4600 -1100 ))",
			})
			wkt = "LINESTRING ( 2100 -1200, 2400 -1700, 2700 -1900, 3100 -2100, 3700 -2200, 4300 -2100, 4800 -1700, 5000 -1400, 5000 -1100, 5000 -900, 4700 -700, 4400 -700, 4300 -900, 4200 -1100, 4300 -1400, 4000 -1700, 3600 -1400, 3600 -1100, 3800 -900, 3800 -700, 3600 -500, 3200 -600, 3100 -900, 3100 -1200, 3100 -1600, 2800 -1600, 2600 -1400, 2500 -1000, 2600 -600, 2800 -300, 3200 -100, 3900 0, 4452.457844881692 -45.940163083620405, 5100 -200, 5400 -600, 5400 -1200 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			contexts = contextGeoms([]string{
				"POLYGON (( 4600 -1100, 4600 -900, 4700 -900, 4700 -1100, 4600 -1100 ))",
				"POLYGON (( 3900 -1500, 3900 -1300, 4000 -1300, 4000 -1500, 3900 -1500 ))",
			})
			wkt = "LINESTRING ( 2100 -1200, 2400 -1700, 2700 -1900, 3100 -2100, 3700 -2200, 4300 -2100, 4800 -1700, 5000 -1400, 5000 -1100, 5000 -900, 4700 -700, 4400 -700, 4300 -900, 4200 -1100, 4300 -1400, 4000 -1700, 3600 -1400, 3600 -1100, 3800 -900, 3800 -700, 3600 -500, 3200 -600, 3100 -900, 3100 -1200, 3100 -1600, 2800 -1600, 2600 -1400, 2500 -1000, 2600 -600, 2800 -300, 3200 -100, 3900 0, 4452.457844881692 -45.940163083620405, 5100 -200, 5400 -600, 5400 -1200 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			contexts = contextGeoms([]string{
				"POLYGON (( 4600 -1100, 4600 -900, 4700 -900, 4700 -1100, 4600 -1100 ))",
				"POLYGON (( 3300 -900, 3300 -700, 3400 -700, 3400 -900, 3300 -900 ))",
			})
			wkt = "LINESTRING ( 2100 -1200, 2400 -1700, 2700 -1900, 3100 -2100, 3700 -2200, 4300 -2100, 4800 -1700, 5000 -1400, 5000 -1100, 5000 -900, 4700 -700, 4400 -700, 4300 -900, 4200 -1100, 4300 -1400, 4000 -1700, 3600 -1400, 3600 -1100, 3800 -900, 3800 -700, 3600 -500, 3200 -600, 3100 -900, 3100 -1200, 3100 -1600, 2800 -1600, 2600 -1400, 2500 -1000, 2600 -600, 2800 -300, 3200 -100, 3900 0, 4452.457844881692 -45.940163083620405, 5100 -200, 5400 -600, 5400 -1200 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			g.Assert(Homotopy(reverse(loads(wkt)), contexts)).IsTrue()

			contexts = contextGeoms([]string{
				"POLYGON (( 300 -2100, 300 -2000, 400 -2000, 400 -2100, 300 -2100 ))",
				"POLYGON (( 1130.8164454717617 -2362.2691388333965, 1130.8164454717617 -2269.2433044111713, 1163.6490929148997 -2269.2433044111713, 1163.6490929148997 -2362.2691388333965, 1130.8164454717617 -2362.2691388333965 ))",
			})
			wkt = "LINESTRING ( -100 -2200, -100 -2400, -200 -2400, -200 -2200, -300 -2200, -300 -2400, -400 -2400, -400 -2000, 0 -2000, 300 -2400, 800 -2000, 1200 -2000, 1300 -2200, 1300 -2400, 1200 -2400, 1200 -2200, 1100 -2200, 1100 -2400, 1000 -2400, 1000 -2100, 1100 -2100, 1098.0081136514539 -2166.7574943693157, 1202.5535156328533 -2166.7574943693157, 1200.4199360005798 -2062.212092387916, 899.5852078500219 -2064.3456720201893, 900 -2200 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			g.Assert(Homotopy(reverse(loads(wkt)), contexts)).IsTrue()

		})

		g.It("should test chain deformation - case 2", func() {
			g.Timeout(1 * time.Hour)
			var contexts = contextGeoms([]string{
				"POLYGON (( 3869.8392857142853 1696.6339285714287, 3869.8392857142853 1795.919642857143, 3944.303571428571 1795.919642857143, 3944.303571428571 1696.6339285714287, 3869.8392857142853 1696.6339285714287 ))",
				"POLYGON (( 3462.767857142857 1671.8125, 3462.767857142857 1766.1339285714287, 3527.303571428571 1766.1339285714287, 3527.303571428571 1671.8125, 3462.767857142857 1671.8125 ))",
			})
			var wkt = "LINESTRING ( 2900 1900, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1900 )"
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			contexts = contextGeoms([]string{
				"POLYGON (( 3869.8392857142853 1696.6339285714287, 3869.8392857142853 1795.919642857143, 3944.303571428571 1795.919642857143, 3944.303571428571 1696.6339285714287, 3869.8392857142853 1696.6339285714287 ))",
				"POLYGON (( 3127.678571428571 1813.2946428571431, 3127.678571428571 1862.9375000000002, 3192.2142857142853 1862.9375000000002, 3157.4642857142853 1815.7767857142858, 3127.678571428571 1813.2946428571431 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//---

			wkt = "LINESTRING ( 2900 2000, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 2000 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 3869.8392857142853 1696.6339285714287, 3869.8392857142853 1795.919642857143, 3944.303571428571 1795.919642857143, 3944.303571428571 1696.6339285714287, 3869.8392857142853 1696.6339285714287 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 2900 2000, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1700 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 3867.3571428571427 1840.5982142857144, 3867.3571428571427 1915.0625000000002, 3941.8214285714284 1915.0625000000002, 3941.8214285714284 1840.5982142857144, 3867.3571428571427 1840.5982142857144 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//---
			wkt = "LINESTRING ( 2900 1700, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1700 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 3867.3571428571427 1840.5982142857144, 3867.3571428571427 1915.0625000000002, 3941.8214285714284 1915.0625000000002, 3941.8214285714284 1840.5982142857144, 3867.3571428571427 1840.5982142857144 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
			contexts = contextGeoms([]string{
				"POLYGON (( 3671.267857142857 1726.419642857143, 3671.267857142857 1800.8839285714287, 3745.7321428571427 1800.8839285714287, 3745.7321428571427 1726.419642857143, 3671.267857142857 1726.419642857143 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 1200 1600, 1200 1400, 1400 1400, 1400 1800, 1600 1800, 1600 1400, 1900 1400, 1900 1700, 1800 1700, 1800 1500, 1700 1500, 1700 1800, 2000 1800, 2000 1400, 2300 1400, 2300 1700, 2200 1700, 2200 1500, 2100 1500, 2100 1800, 2400 1800, 2400 1400, 2600 1400, 2600 1600 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 2129.513922639765 1723.761514888764, 2129.513922639765 1773.9563365958334, 2184.271909956568 1773.9563365958334, 2184.271909956568 1723.761514888764, 2129.513922639765 1723.761514888764 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//---
			wkt = "LINESTRING ( 1750 -400, 1750 -450, 1750 -500, 1800 -500, 1900 -500, 1950 -500, 1950 -450, 1950 -350, 1950 -300, 2050 -300, 2100 -300, 2100 -350, 2100 -450, 2100 -500, 2200 -500, 2300 -500, 2300 -450, 2300 -400 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 2168.288964021391 -373.4962796735084, 2168.288964021391 -338.12469248046824, 2223.653187453976 -338.12469248046824, 2223.653187453976 -373.4962796735084, 2168.288964021391 -373.4962796735084 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 1600 -150, 1750 -150, 1900 -150, 2100 -150, 2300 -150, 2400 -150 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 1972.976286911995 -170.49412708736446, 1972.976286911995 -121.28148403617807, 2040.6436711073763 -121.28148403617807, 2040.6436711073763 -170.49412708736446, 1972.976286911995 -170.49412708736446 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 1264.63412261399 -816.1475500911281, 1246.3493739893286 -705.2200751015158, 1145.8968390998311 -629.8806739343928, 1049.8760336907526 -644.6531055357895, 993.7407936054453 -686.0159140197002, 962.7186872425123 -753.9690993861249, 987.8318209648867 -827.8312573931083, 1020.3311704879593 -861.8078500763207, 1000 -900, 924.3103650788809 -882.489254318276, 881.4703134348305 -684.5386708595605, 981.9228483243279 -579.654406489644, 1210.8955381459766 -569.3137043686663, 1324.643261476731 -631.3579170945325, 1355.665367839664 -860.3306069161811 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 1094.1877768135796 -738.7691521063977, 1094.1877768135796 -678.8470675277442, 1159.9845755666108 -678.8470675277442, 1159.9845755666108 -738.7691521063977, 1094.1877768135796 -738.7691521063977 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			contexts = contextGeoms([]string{
				"POLYGON (( 1068.1238148545565 -613.5138609084431, 1068.1238148545565 -596.9952077923107, 1162.5161183753135 -596.9952077923107, 1162.5161183753135 -613.5138609084431, 1068.1238148545565 -613.5138609084431 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			wkt = "LINESTRING ( 100 -800, 100 -900, 0 -900, 0 -800, 0.2279944958968561 -732.9285667808929, 132.15239407341494 -718.6367568266617, 200 -800, 250.88435369318123 -770.3071466611897, 200 -900, 300 -900, 300 -700, 600 -700, 662.3522083102516 -834.4510759307058, 600 -900, 500 -900, 481.4875419749193 -848.8252805471226, 476.4860592642242 -729.0404143735325, 508.2690102493364 -758.6438814875202, 560.2154504813326 -809.0749601144098, 560.4781417236578 -845.2851008091432, 598.7632595356365 -846.4982672867561, 600 -800 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 144.25914414514722 -861.2936576504302, 144.25914414514722 -825.8965438301464, 177.29645037741216 -825.8965438301464, 177.29645037741216 -861.2936576504302, 144.25914414514722 -861.2936576504302 ))",
				"POLYGON (( 327.14423221661394 -841.2352931522694, 327.14423221661394 -817.6372172720801, 464.01307232171166 -817.6372172720801, 464.01307232171166 -841.2352931522694, 327.14423221661394 -841.2352931522694 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			contexts = contextGeoms([]string{
				"POLYGON (( 144.25914414514722 -861.2936576504302, 144.25914414514722 -825.8965438301464, 177.29645037741216 -825.8965438301464, 177.29645037741216 -861.2936576504302, 144.25914414514722 -861.2936576504302 ))",
				"POLYGON (( 327.14423221661394 -841.2352931522694, 327.14423221661394 -817.6372172720801, 464.01307232171166 -817.6372172720801, 464.01307232171166 -841.2352931522694, 327.14423221661394 -841.2352931522694 ))",
				"POLYGON (( 340.12317395071807 -740.943470661465, 340.12317395071807 -713.8056833992473, 355.4619232728411 -713.8056833992473, 355.4619232728411 -740.943470661465, 340.12317395071807 -740.943470661465 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			wkt = "LINESTRING ( 100 -800, 100 -900, 0 -900, 0 -800, 0 -700, 100 -700, 200 -850, 250 -750, 200 -700, 300 -750, 300 -700, 600 -700, 700 -700, 700 -900, 400 -900, 400 -800, 500 -850, 450 -750, 550 -800, 550 -850, 600 -850, 600 -800 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 166.677316231327 -752.7425086015596, 166.677316231327 -733.8640478974082, 189.0954883175068 -733.8640478974082, 189.0954883175068 -752.7425086015596, 166.677316231327 -752.7425086015596 ))",
				"POLYGON (( 453.3939381756265 -821.1769286541085, 453.3939381756265 -809.3778907140138, 471.09249508576846 -809.3778907140138, 471.09249508576846 -821.1769286541085, 453.3939381756265 -821.1769286541085 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			wkt = "LINESTRING ( 700 -2200, 700 -2300, 600 -2300, 600 -2243.79030774452, 600.2279944958968 -2132.9285667808927, 700 -2100, 773.5495599967953 -2296.290075298598, 770.8070205790568 -2119.154350990156, 800 -2100, 850 -2100, 900 -2150, 850 -2250, 850 -2150, 800 -2150, 800 -2300, 900 -2300, 1000 -2300, 996.446939818906 -2100, 1200 -2100, 1262.3522083102516 -2234.451075930705, 1200 -2300, 1100 -2300, 1081.4875419749194 -2248.825280547122, 1076.4860592642242 -2129.0404143735323, 1130.272927835954 -2200, 1156.5463123397549 -2146.9597281812107, 1187.4561764618736 -2142.323248562893, 1200 -2200 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 815.6266818663547 -2189.792859736706, 815.6266818663547 -2172.725129996781, 828.815382119933 -2172.725129996781, 828.815382119933 -2189.792859736706, 815.6266818663547 -2189.792859736706 ))",
				"POLYGON (( 1139.913546924927 -2254.960555107328, 1139.913546924927 -2233.2379899837874, 1158.5328884593905 -2233.2379899837874, 1158.5328884593905 -2254.960555107328, 1139.913546924927 -2254.960555107328 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			wkt = "LINESTRING ( -200 200, -200 400, 100 400, 400 300, 500 200, 200 0, -100 0, -100 300, 0 300, 0 100, 43.854064615772806 142.4893513155663, 45.08146541361937 300.6646040804819, 100 300, 100 100, 200 100, 300 200, 300 300 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 183.55760192339608 171.38061829418723, 183.55760192339608 226.9616208933914, 212.02592032786652 226.9616208933914, 212.02592032786652 171.38061829418723, 183.55760192339608 171.38061829418723 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			wkt = "LINESTRING ( 586.1365464176768 340.48547016799586, 586.9077247835168 292.6344641285775, 604.4360595339316 263.18686174788064, 652.8142634450764 237.2449263172667, 751.674071437416 228.8313256370676, 867.3610807901538 247.7619271675156, 890.4984826607014 329.09340040944033, 876.4758148603695 392.19540551093365, 827.396477559208 420.24074111159734, 799.3511419585443 413.930540601448, 797.2477417884945 390.79313873090047, 826.6953441691915 366.25347008031974, 846.327079089656 353.63306906002106, 856.8440799399049 326.28886684937396, 849.8327460397389 298.94466463872686, 822.4885438290919 288.42766378847796, 788.8341411082954 302.45033158880983, 775.5126066979802 355.03533584005424, 761.4899388976484 381.67840466068475, 734.1457366870012 379.57500449063497, 717.318535326603 331.1968005794901, 717.318535326603 294.0367309086107, 659.1244639552258 294.0367309086107, 631.0791283545622 371.1614038104359, 650.0097298850101 447.58494332224444, 688.5720663359227 481.9404794330575, 761.4899388976484 502.9744811335553, 837.913478409457 498.06654740343913, 900.3143501209337 467.91781163272566, 931.8653526716803 420.24074111159734, 947.2902872520453 370.4602704204193, 947.4987309748076 338.3020128594936 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 743.3166493090184 306.7672174144118, 743.3166493090184 330.34346454026723, 759.8200222971171 330.34346454026723, 759.8200222971171 306.7672174144118, 743.3166493090184 306.7672174144118 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
			contexts = contextGeoms([]string{
				"POLYGON (( 802.9281972119478 302.2418229616, 802.9281972119478 325.81807008745545, 819.4315702000465 325.81807008745545, 819.4315702000465 302.2418229616, 802.9281972119478 302.2418229616 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 800 -400, 840.0021638548561 -355.1442890183745, 838.9770190849463 -276.20814173531585, 911.7622977485457 -211.62402123099514, 1070.6597370845727 -189.0708362929784, 1173.2829374993098 -215.59072092640855, 1209.6229881620284 -276.5482252638715, 1243.6185194271518 -338.67798930013174, 1245.376908975348 -440.66458309550234, 1136.2690023588032 -466.88506893854833, 1024.5282224386294 -475.08622709782713, 959.8953249291841 -436.02696050261244, 939.1999511343239 -369.04011688525804, 945.5920751555708 -315.16364299189024, 996.8493136510634 -289.5350237441439, 1069.6345923146628 -281.3338655848651, 1138.3192918986229 -302.861905752972, 1175.6274568969047 -342.7808982459225, 1200 -400 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 1038.7094216038986 -361.7992988000302, 1038.7094216038986 -319.82948780257595, 1076.3532753410843 -319.82948780257595, 1076.3532753410843 -361.7992988000302, 1038.7094216038986 -361.7992988000302 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//----
			wkt = "LINESTRING ( 231.31696746126295 -168.4417854573867, 186.75351543760672 -142.37637012279532, 125.37366642389154 -138.59268080003204, 98.04702131504574 -157.0907174890969, 82.91226402399269 -191.56433131871776, 90.47964266951921 -257.14827957994765, 121.58997710112827 -265.5564780749771, 139.24719394069018 -245.79721161165787, 130.43051435450164 -213.6746310114183, 131.8610207147146 -189.83285834120238, 149.75744205947703 -180.21326335042795, 167.14684426663416 -187.4486810741808, 174.1786808187153 -216.63647446162548, 190.11679483561852 -215.94810695430323, 211.55770099794367 -218.0501565780606, 218.48147950375636 -211.34561416286152, 214.92098039595547 -195.7684305662325, 203.27876650877175 -191.0561058976105, 191.37802460987294 -172.64588470490142, 149.5039324906744 -159.315389323326, 121.84747619322391 -171.7131111118383, 109.818499208087 -203.75621913651048, 112.76136868134732 -235.28696349287102 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 145.80114866651235 -203.98529435342198, 145.80114866651235 -194.721810159433, 153.97481119062024 -194.721810159433, 153.97481119062024 -203.98529435342198, 145.80114866651235 -203.98529435342198 ))",
				"POLYGON (( 152.34007868579866 -233.4104794402105, 152.34007868579866 -224.1469952462215, 163.78320621954975 -224.1469952462215, 163.78320621954975 -233.4104794402105, 152.34007868579866 -233.4104794402105 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
			//----
			wkt = "LINESTRING ( 405.4864204322907 -229.58286228018753, 425.0781379743377 -253.83927447510288, 427.2549954790096 -290.2238927674759, 401.44182689507295 -322.07653073017025, 348.5458087250717 -353.04792453986676, 308.14979200910466 -358.9503939864028, 276.44764762700964 -332.55464952148867, 277.98476658722274 -321.3218571199315, 291.35689125877866 -316.03520318001404, 312.5035070184485 -333.4500632173892, 343.9124510144286 -333.13908357386464, 358.5284942600827 -310.4375695965721, 336.1379599263147 -299.5532820732126, 323.0768148982834 -285.8701777581321, 324.009753828857 -264.4125823549378, 334.27208206516735 -252.2843762574801, 357.93141243911913 -253.09267848384158, 385.5837232467191 -276.5407884523955, 399.88878684884867 -265.656500929036, 385.27274360319456 -244.50988516936619, 353.2418403201653 -235.4914755071541, 317.47918131484136 -242.95498695174342, 300.68628056451536 -263.79062306788865, 303.48509735623634 -300.79720064731083, 326.80857062057805 -317.59010139763683 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 337.9832718619027 -281.24881893305763, 337.9832718619027 -266.27080432520825, 348.46788208739736 -266.27080432520825, 348.46788208739736 -281.24881893305763, 337.9832718619027 -281.24881893305763 ))",
				"POLYGON (( 336.0730323177134 -322.7531144840838, 336.0730323177134 -316.2409342198015, 344.3217939858044 -316.2409342198015, 344.3217939858044 -322.7531144840838, 336.0730323177134 -322.7531144840838 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			//----
			wkt = "LINESTRING ( 556.3168307987446 -510.59554811847573, 580.9918224566356 -525.2574996833096, 583.4950824799 -534.1977140521107, 580.9918224566356 -546.1776013063042, 570.0847609266983 -550.4689042033286, 550 -550, 526.2777105195729 -544.56836271992, 513.7614104032514 -533.1248883278545, 516.6222790012678 -525.2574996833096, 533.7874905893658 -530.4428240172142, 546.357519445215 -537.3379535073677, 567.2238923286819 -538.8466255238872, 572.482645623269 -529.8454090923761, 559.7737596898011 -532.6376961764413, 549.235818167535 -526.1283444361657, 529.5793157524432 -523.5743361995253, 522.7637440596187 -511.46745157188184, 523.248729213637 -500.31279302945893, 533.5110574499474 -488.18458693200125, 557.1703878238991 -488.99288915836274, 584.8226986314992 -512.4409991269166, 599.1277622336288 -501.5567116035571, 584.5117189879745 -480.41009584388735, 552.4808157049454 -471.39168618167525, 516.7181566996214 -478.8551976262646, 499.9252559492954 -499.69083374240984, 502.7240727410164 -536.6974113218321, 528.7809705428373 -554.5814028129771 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 550.2911722692357 -534.5651636768148, 550.2911722692357 -531.6053955616723, 554.0298267304685 -531.6053955616723, 554.0298267304685 -534.5651636768148, 550.2911722692357 -534.5651636768148 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			//----
			wkt = "LINESTRING ( -1084.4988433252431 521.111081244408, -1135.744149563382 648.1103184432739, -1111.235524840794 721.6361926110385, -987.4261724776833 769.8805101847079, -886.4261724776833 748.8805101847079, -807.4261724776833 711.8805101847079, -576.5018945297793 685.9872839236375, -459.52891289924486 580.1545862579158, -508.5673916043536 549.7974327738009, -522.3807034369273 510.7324330662167, -582.1898624298948 467.6346567330489, -626.3333270792406 476.8947108131565, -708.0889857743063 446.8089546887712, -810.8719409324174 472.0323890119436, -866.2833676464902 508.9733401546588, -879.2000977328564 559.7661352556775, -890.0311219525214 606.6029967461204, -941.0448163876995 632.9893904194884, -959.5152919590571 613.6393683923518, -971.8289423399622 574.9393243380788, -949.8402809454889 522.1665369913428, -977.9857675304147 500.17787559686946, -1018.4449044962456 515.1301653451113, -1035.8174768255094 583.5761623586209, -1034.9910341625227 634.8307112947399, -1000.1014790142217 677.9711774122405, -949.7305203037703 686.1848580107949, -898.8609550863789 680.5326840977514, -864.5131289994224 653.5761623586209, -851.0348681298572 591.4022493151426, -826.6870420429007 530.967466706447, -746.9482391914153 504.4006552971888, -673.4223650236506 540.0495639845897, -623.2910871819931 519.9970528479266, -572.4261724776834 584.8805101847079, -606.842710926458 628.7740664672033 )"
			contexts = contextGeoms([]string{
				"POLYGON (( -941.9243628434784 577.5779637054156, -941.9243628434784 607.4825432018994, -919.0561549932262 607.4825432018994, -919.0561549932262 577.5779637054156, -941.9243628434784 577.5779637054156 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
			contexts = contextGeoms([]string{
				"POLYGON (( -695.529898348629 567.4694728543449, -695.529898348629 597.3740523508286, -672.6616904983767 597.3740523508286, -672.6616904983767 567.4694728543449, -695.529898348629 567.4694728543449 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()

			//---
			wkt = "LINESTRING ( 1100 500, 1113.7207423404 450.39197302557125, 1142.1754080967698 419.56608512283736, 1216.4737020161797 383.2073455452538, 1267.8501818540694 371.3512348134331, 1316.855439545595 383.99775292737525, 1357.9566234159067 414.0332334479877, 1377.7168079689413 463.8288985216347, 1376.1359932046985 513.6245635952816, 1358.7470307980282 546.0312662622583, 1303.4185140495315 558.6777843762004, 1289.1911811713467 544.4504514980156, 1287.6103664071038 527.0614890913452, 1300.256884521046 487.5411199852761, 1293.1432180819536 442.4878992043574, 1267.8501818540694 440.90708444011466, 1240.7845244757145 454.7023280373146, 1200 500, 1201.4559617558734 571.3243024901425, 1222.7969610731507 599.7789682465122, 1320.8074764562018 610.8446715962116, 1388.7825113186407 590.2940796610557, 1426.722065660467 537.3367850589232, 1444.1110280671373 458.29604684678503 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 1325.5499207489302 500.9780454813396, 1325.5499207489302 522.3190447986169, 1344.5196979198433 522.3190447986169, 1344.5196979198433 500.9780454813396, 1325.5499207489302 500.9780454813396 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			contexts = contextGeoms([]string{
				"POLYGON (( 1255.9940711222487 455.1344173182995, 1255.9940711222487 468.571342814363, 1281.2871073501328 468.571342814363, 1281.2871073501328 455.1344173182995, 1255.9940711222487 455.1344173182995 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			contexts = contextGeoms([]string{
				"POLYGON (( 1255.9940711222487 455.1344173182995, 1255.9940711222487 468.571342814363, 1281.2871073501328 468.571342814363, 1281.2871073501328 455.1344173182995, 1255.9940711222487 455.1344173182995 ))",
				"POLYGON (( 1325.5499207489302 500.9780454813396, 1325.5499207489302 522.3190447986169, 1344.5196979198433 522.3190447986169, 1344.5196979198433 500.9780454813396, 1325.5499207489302 500.9780454813396 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()

			//---
			wkt = "LINESTRING ( 1600 -150, 1652.4561819485814 -150, 1697.0868374810743 -150, 1752.1313126378157 -150, 1801.9688779824328 -150, 1849.5749105504253 -150, 1900 -150, 1900 -96.61943169837312, 1900 -50.50108764813037, 1900 1.5680104731114284, 1900 50, 1949.9938854985346 50, 2002.8068278786513 50, 2012.4768032440247 50, 2048.181327670019 50, 2100 50, 2100 -1.4073665623880984, 2100 -51.98877616588013, 2100 -100.33865299274751, 2100 -150, 2147.8564583592533 -150, 2201.413244998245 -150, 2248.2754333073626 -150, 2300.3445314286046 -150, 2351.6697852909715 -150, 2400 -150 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 2266.871539779235 -169.51616906811165, 2266.871539779235 -141.2500872308661, 2286.2114905099816 -141.2500872308661, 2286.2114905099816 -169.51616906811165, 2266.871539779235 -169.51616906811165 ))",
				"POLYGON (( 1850 -200, 1850 -100, 1950 -100, 1950 -200, 1850 -200 ))",
				"POLYGON (( 1648.736960654207 -159.1023494438633, 1648.736960654207 -141.993931489741, 1760.3135994854395 -141.993931489741, 1760.3135994854395 -159.1023494438633, 1648.736960654207 -159.1023494438633 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsTrue()
			//---
			wkt = "LINESTRING ( 1600 -150, 1652.4561819485814 -150, 1697.0868374810743 -150, 1752.1313126378157 -150, 1801.9688779824328 -150, 1849.5749105504253 -150, 1900 -150, 1900 -96.61943169837312, 1900 -50.50108764813037, 1900 1.5680104731114284, 1900 50, 1949.9938854985346 50, 2002.8068278786513 50, 2012.4768032440247 50, 2048.181327670019 50, 2100 50, 2100 -1.4073665623880984, 2100 -51.98877616588013, 2100 -100.33865299274751, 2100 -150, 2147.8564583592533 -150, 2201.413244998245 -150, 2248.2754333073626 -150, 2300.3445314286046 -150, 2351.6697852909715 -150, 2400 -150 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 2086.0430004467503 -85.42457560230622, 2086.0430004467503 -69.06000190705879, 2125.466746167119 -69.06000190705879, 2125.466746167119 -85.42457560230622, 2086.0430004467503 -85.42457560230622 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
			//---
			wkt = "LINESTRING ( 1600 -150, 1652.4561819485814 -150, 1697.0868374810743 -150, 1752.1313126378157 -150, 1801.9688779824328 -150, 1849.5749105504253 -150, 1900 -150, 1900 -96.61943169837312, 1900 -50.50108764813037, 1900 1.5680104731114284, 1900 50, 1949.9938854985346 50, 2002.8068278786513 50, 2012.4768032440247 50, 2048.181327670019 50, 2100 50, 2100 -1.4073665623880984, 2100 -51.98877616588013, 2100 -100.33865299274751, 2100 -150, 2147.8564583592533 -150, 2201.413244998245 -150, 2248.2754333073626 -150, 2300.3445314286046 -150, 2351.6697852909715 -150, 2400 -150 )"
			contexts = contextGeoms([]string{
				"POLYGON (( 1973.0591720251218 -175.45313945712886, 1973.0591720251218 -125.45313945712886, 2000 -150, 1999.999767018935 -175.4348537833418, 1973.0591720251218 -175.45313945712886 ))",
			})
			g.Assert(Homotopy(loads(wkt), contexts)).IsFalse()
		})
	})
}

func TestHomotopyDeformationCmplx(t *testing.T) {
	g := goblin.Goblin(t)
	g.Describe("homotopic sidedness test", func() {
		g.It("should test sidedness to a context geometry", func() {
			g.Timeout(1 * time.Hour)
			var cwkt = "POLYGON (( 278 307, 270 298, 274 286, 279 272, 301 274, 308 288, 311 304, 296 308, 278 307 ))"
			var wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 214 295, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 195 264, 187 230, 216 215, 257 226, 273 217, 273 205, 240 197, 200 200, 178 193, 157 226, 156 246, 151 263, 120 264, 95 249, 89 261, 100 300, 116 359, 139 389, 172 413, 211 425, 256 430, 289 431, 348 427 )"
			var coords = loads(wkt)
			var cgs = ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0).AsContextGeometries()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			cwkt = "POLYGON (( 221 347, 205 334, 221 322, 234 324, 237 342, 221 347 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			cwkt = "POLYGON (( 221 347, 205 334, 221 322, 234 324, 237 342, 221 347 ))"
			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 366.3526316090967 196.8011373660995, 403.24889098928804 217.07380735521562, 449.06512516469047 258.02460073323016, 469.7432485535889 310.7335427049321, 431.6306289740506 348.8461622844704, 393.9234627942946 354.9279632812052, 371.21807240648457 309.92263590536743, 372.43443260583155 253.97006673540696, 415.4124929827577 249.91553273758373, 425.14337457753345 316.00443690210227, 404.465251188635 331.81711949361284, 359.0544704130149 294.10995331385686, 333 347, 365.94717820931436 412.50234605029505, 350.9454024173684 441.6949908346222, 269.44926906112164 441.6949908346222, 233.36391648049494 444.9386180328808, 205.38763189551466 402.77146445551926, 204 370, 176 337, 180 305, 214 295, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 195 264, 187 230, 216 215, 257 226, 273 217, 273 205, 240 197, 200 200, 178 193, 157 226, 156 246, 151 263, 120 264, 95 249, 89 261, 100 300, 116 359, 139 389, 172 413, 211 425, 256 430, 289 431, 348 427 )"
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			cgs = ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0).AsContextGeometries()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			cwkt = "POLYGON (( 278 307, 270 298, 274 286, 279 272, 301 274, 308 288, 311 304, 296 308, 278 307 ))"
			cgs = ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0).AsContextGeometries()
			g.Assert(
				Homotopy(coords, cgs),
			).IsTrue()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 366.3526316090967 196.8011373660995, 403.24889098928804 217.07380735521562, 449.2399093677868 286.1290060157034, 451.783228702019 325.7276851722446, 415.8591984439269 355.71930167053, 418.6880722510337 402.11283210708103, 389.8335594185446 420.2176244725644, 350.9454024173684 441.6949908346222, 269.44926906112164 441.6949908346222, 233.36391648049494 444.9386180328808, 205.38763189551466 402.77146445551926, 204 370, 176 337, 180 305, 157 226, 95 249, 89 261, 100 300, 116 359, 139 389, 172 413, 211 425, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 278 307, 270 298, 274 286, 279 272, 301 274, 308 288, 311 304, 296 308, 278 307 ))"
			cgs = ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0).AsContextGeometries()
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(
				Homotopy(coords, cgs),
			).IsFalse()

			cwkt = "POLYGON (( 221 347, 205 334, 221 322, 234 324, 237 342, 221 347 ))"
			cgs = ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0).AsContextGeometries()
			g.Assert(
				Homotopy(coords, cgs),
			).IsTrue()

			coords = []*geom.Point{{2, 2}, {5, 2}, {7, 2}, {9, 2}}
			var lnconst = geom.NewLineString([]*geom.Point{{3, 2}, {6, 2}, {6.5, 2}})
			cgs = ctx.New(lnconst, -1, 0).AsContextGeometries()
			g.Assert(
				Homotopy(coords, cgs),
			).IsTrue()

			var plyconst = geom.NewPolygon([]*geom.Point{{4, 1}, {4, 3}, {5, 3}, {5, 1}})
			cgs = ctx.New(plyconst, -1, 0).AsContextGeometries()
			g.Assert(
				Homotopy(coords, cgs),
			).IsTrue()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 214 295, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 219.58661514683152 241.09585780525492, 203.57969088098918 278.07737248840795, 222.34642967542504 355.9041421947449, 211 425, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 278 307, 268.711313755796 290.77251931993817, 235.45711654915712 296.5278817518552, 232.8337248840804 286.90877897990725, 277.40587928436713 278.46806414206173, 285.4987949850666 282.69941864135717, 288.58197836166926 290.77251931993817, 290.2378670788254 299.05196290571865, 278 307 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(
				Homotopy(coords, cgs),
			).IsFalse()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 205.2355795981453 296.29214837712516, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 219.58661514683152 241.09585780525492, 203.57969088098918 278.07737248840795, 225.65820710973728 312.29907264296753, 246.63279752704796 324.99421947449764, 255.46420401854718 354.24825347758883, 223.45035548686246 391.22976816074186, 233.93765069551782 421.58772797527047, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 221 347, 205 334, 221 322, 234 324, 237 342, 221 347 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(
				Homotopy(coords, cgs),
			).IsFalse()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 205.2355795981453 296.29214837712516, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 219.58661514683152 241.09585780525492, 203.57969088098918 278.07737248840795, 225.65820710973728 312.29907264296753, 246.63279752704796 324.99421947449764, 255.46420401854718 354.24825347758883, 223.45035548686246 391.22976816074186, 233.93765069551782 421.58772797527047, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 232.00298146975462 210.52416263821522, 232.00298146975462 220.68605060410567, 246.51996427816957 220.68605060410567, 246.51996427816957 210.52416263821522, 232.00298146975462 210.52416263821522 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 205.2355795981453 296.29214837712516, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 219.58661514683152 241.09585780525492, 203.57969088098918 278.07737248840795, 225.65820710973728 312.29907264296753, 246.63279752704796 324.99421947449764, 255.46420401854718 354.24825347758883, 223.45035548686246 391.22976816074186, 233.93765069551782 421.58772797527047, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsFalse()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 205.2355795981453 296.29214837712516, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 203.26715129630935 235.02274990598545, 211.59588065682914 246.07018366916196, 217.04481846253088 253.29779029226893, 222.32389329119033 260.30008643805553, 226.53649692090931 265.8877886619315, 203.57969088098918 278.07737248840795, 225.65820710973728 312.29907264296753, 246.63279752704796 324.99421947449764, 255.46420401854718 354.24825347758883, 223.45035548686246 391.22976816074186, 233.93765069551782 421.58772797527047, 256 430, 289 431, 348 427 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))
			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsFalse()

			wkt = "LINESTRING ( 155 171, 207 166, 253 175, 317 171, 367 182, 400 200, 428 249, 417 291, 383 324, 361 332, 333 347, 314 357, 257 383, 204 370, 176 337, 180 305, 205.2355795981453 296.29214837712516, 244 302, 281 332, 316 328, 331 306, 332 291, 315 265, 285 250, 247 261, 231 276, 175.9815455950541 265.3822256568778, 187 230, 233.38568778979908 233.9203400309118, 265.9514992272025 234.4723029366305, 274.230942812983 207.97808346213282, 248.54273709311704 199.72323889171014, 215.17091190108192 192.52312210200918, 203.26715129630935 235.02274990598545, 211.59588065682914 246.07018366916196, 217.04481846253088 253.29779029226893, 222.32389329119033 260.30008643805553, 226.53649692090931 265.8877886619315, 348 427 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))

			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(
				Homotopy(coords, cgs),
			).IsFalse()

			wkt = "LINESTRING ( 155 171, 169.0211940381559 189.5980604858441, 178.36905451652774 201.99729511000572, 189.61729454361603 216.9172404309104, 155.33584906460158 235.98971111300912, 171.9249231022847 253.04608301090866, 184.81805947947288 266.3024063282993, 199.21035949720948 260.0405937778234, 216.46768369629606 252.53226438472433, 226.72184529093568 266.1336393496349, 253.77293550266072 261.8918612097899, 286.55244753078927 256.75183112348185, 298.89980243113513 277.3307559573916, 308.9755371420998 294.1236471423328, 311.6569923092747 322.2091261672002, 274.3587106022468 329.32036224961234, 286.70927127817396 345.7024530943654, 302.96002907406313 367.25786239875725, 265.3750851201071 385.89221758862226, 267.0360547209449 409.9762768007707, 292.87995239405126 407.8640164833156, 311.8206399330813 406.3159658301186, 333.85824574639133 408.2420254459906, 348 427 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))

			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			wkt = "LINESTRING ( 90 270, 120 270, 150 270, 190 220, 150 230, 180 250, 180 270, 200 250, 210 270, 230 260, 250 270, 280 270, 300 270, 310 290, 310 320, 400 270, 380 270, 340 270, 380 310, 410 270, 450 310, 430 270, 470 270 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))

			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			wkt = "LINESTRING ( 90 270, 470 270 )"
			cwkt = "POLYGON (( 211.34885547628429 235.3767011676454, 211.34885547628429 241.48063878287113, 213.69652378983264 241.48063878287113, 213.69652378983264 235.3767011676454, 211.34885547628429 235.3767011676454 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))

			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

			wkt = "LINESTRING ( 90 270, 470 270 )"
			cwkt = "POLYGON (( 370 260, 370 300, 380 300, 380 260, 370 260 ))"
			cgs = ctx.NewContexts(ctx.New(geom.NewPolygonFromWKT(cwkt), -1, 0))

			coords = geom.NewLineStringFromWKT(wkt).Coordinates()
			g.Assert(Homotopy(coords, cgs), ).IsTrue()

		})

	})

}

func TestHomotopyDeformationCmplx2(t *testing.T) {
	g := goblin.Goblin(t)

	g.Describe("context neighbours", func() {
		g.It("should test context neighbours", func() {
			wkt := "LINESTRING ( 400 560, 520 660, 620 600, 720 640, 760 500, 680 460, 720 420, 780 400, 720 360, 580 340, 440 400, 380 440, 440 500, 400 560 )"
			cgs := ctx.NewContexts(ctx.New(geom.NewLineStringFromWKT(wkt), -1, 0))

			wkt_a := "LINESTRING ( 980 280, 981.3546694489717 324.82716460080917, 1006.1665140838959 336.10527579850196, 1026.4671142397428 362.0449315531954, 1017.4446252815886 410.5408097032744, 982.4824805687409 427.45797649981364, 947.5203358558933 470.31479905104624, 948.6481469756626 585.3515332675128, 921.5806801011998 611.2911890222063, 906.9191355441992 613.5468112617448, 843.7617128371196 666.5539338909009, 734.3640342194994 743.245090035212, 700 750, 650 750, 465.94498771441084 773.6959902689825, 412.93786508525466 739.8616566759041, 385.87039821079196 720.6888676398264, 361.0585535758678 717.3054342805185, 346.29722623487015 749.9852989139027, 315.5582431228852 768.0047028071353, 275.2795755968359 771.1845976118235, 246.660522354643 707.5867015180614, 265.00252427153964 657.6454550927426, 220.85197491460565 627.9662944103014, 156.8861009121442 574.9681901708519, 118.727363255887 505.01050446771376, 143.10655675849577 442.47257330884776, 122.96722299547113 361.9152382567492, 132.50690740953544 334.35614994945234, 193.01469673024513 224.45197494134325, 216.6987302454 210.9182415041119, 232.48808592216992 168.06141895287928, 300.1567531083267 120.69335192256952 )"
			wkt_b := "LINESTRING ( 310 540, 460 710, 540 950, 500 1140, 600 1080, 660 930 )"
			wkt_c := "LINESTRING ( 859.5510685138895 630.4639780582839, 850 650, 843.7617128371196 666.5539338909009, 826.8445460405803 677.8320450885938, 796.3936458068098 716.1776231607492, 791.8824013277327 726.3279232386727, 782.8599123695784 737.6060344363656, 734.3640342194994 743.245090035212, 700 750, 650 750, 618.1994888832636 772.5681791492133, 536.9970882598755 793.9965904248296, 500 800, 465.94498771441084 773.6959902689825, 412.93786508525466 739.8616566759041, 385.87039821079196 720.6888676398264, 361.0585535758678 717.3054342805185, 346.29722623487015 749.9852989139027, 315.5582431228852 768.0047028071353, 275.2795755968359 771.1845976118235, 246.660522354643 707.5867015180614, 265.00252427153964 657.6454550927426, 220.85197491460565 627.9662944103014, 156.8861009121442 574.9681901708519, 118.727363255887 505.01050446771376, 143.10655675849577 442.47257330884776, 114.31878332472097 397.14041836991646, 122.96722299547113 361.9152382567492, 132.50690740953544 334.35614994945234, 179.48096329301376 311.2934311635778, 162.56379649647457 295.5040754868079, 155.79692977785888 260.5419307739602, 193.01469673024513 224.45197494134325, 216.6987302454 210.9182415041119, 232.48808592216992 168.06141895287928, 300.1567531083267 120.69335192256952 )"
			wkt_d := "LINESTRING ( 859.5510685138895 630.4639780582839, 850 650, 843.7617128371196 666.5539338909009, 826.8445460405803 677.8320450885938, 796.3936458068098 716.1776231607492, 791.8824013277327 726.3279232386727, 782.8599123695784 737.6060344363656, 734.3640342194994 743.245090035212, 700 750, 650 750, 618.1994888832636 772.5681791492133, 536.9970882598755 793.9965904248296, 500 800, 465.94498771441084 773.6959902689825, 412.93786508525466 739.8616566759041, 385.87039821079196 720.6888676398264, 361.0585535758678 717.3054342805185, 346.29722623487015 749.9852989139027, 315.5582431228852 768.0047028071353, 275.2795755968359 771.1845976118235, 246.660522354643 707.5867015180614, 265.00252427153964 657.6454550927426, 220.85197491460565 627.9662944103014, 156.8861009121442 574.9681901708519, 118.727363255887 505.01050446771376, 190 510, 260 500, 310 440, 370 400, 450 280 )"

			pln_a := loads(wkt_a)
			pln_b := loads(wkt_b)
			pln_c := loads(wkt_c)
			pln_d := loads(wkt_d)

			g.Assert(Homotopy(pln_a, cgs)).IsFalse()
			g.Assert(Homotopy(pln_b, cgs)).IsTrue()
			g.Assert(Homotopy(pln_c, cgs)).IsFalse()
			g.Assert(Homotopy(pln_d, cgs)).IsFalse()

		})
	})

}
