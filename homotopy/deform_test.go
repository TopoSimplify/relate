package homotopy

import (
	"testing"
	"github.com/franela/goblin"
	"github.com/intdxdt/geom"
	"fmt"
	"time"
)

func loads(wkt string) []*geom.Point {
	return geom.NewLineStringFromWKT(wkt).Coordinates()
}
func printPolys(sb *SBounds) {
	for _, o := range sb.Regions {
		fmt.Println(o.WKT())
	}
}

func TestHomotopyEvenDeformation(t *testing.T) {
	g := goblin.Goblin(t)
	g.Describe("context homotopy case - 1", func() {
		g.It("should test even number of intersects", func() {
			g.Timeout(1 * time.Hour)
			var wkt = "LINESTRING ( 2900 1900, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1900 )"
			var sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(3)

			wkt = "LINESTRING ( 2900 2000, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 2000 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(3)

			wkt = "LINESTRING ( 2900 2000, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1700 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(3)

			wkt = "LINESTRING ( 2900 1700, 2900 1600, 3000 1600, 3000 2000, 4000 2000, 4000 1600, 3800 1600, 3800 1900, 3600 1800, 3600 1600, 3400 1600, 3400 1900, 3100 1900, 3100 1600, 3200 1600, 3200 1800, 3300 1800, 3300 1600, 3300 1500, 4100 1500, 4100 1700 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(5)

			wkt = "LINESTRING ( 1200 1600, 1200 1400, 1400 1400, 1400 1800, 1600 1800, 1600 1400, 1900 1400, 1900 1700, 1800 1700, 1800 1500, 1700 1500, 1700 1800, 2000 1800, 2000 1400, 2300 1400, 2300 1700, 2200 1700, 2200 1500, 2100 1500, 2100 1800, 2400 1800, 2400 1400, 2600 1400, 2600 1600 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(7)

			wkt = "LINESTRING ( 1750 -400, 1750 -450, 1750 -500, 1800 -500, 1900 -500, 1950 -500, 1950 -450, 1950 -350, 1950 -300, 2050 -300, 2100 -300, 2100 -350, 2100 -450, 2100 -500, 2200 -500, 2300 -500, 2300 -450, 2300 -400 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(3)

			wkt = "LINESTRING ( 1600 -150, 1900 -150, 1900 50, 2100 50, 2100 -150, 2400 -150 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(1)

			wkt = "LINESTRING ( 1600 -150, 1750 -150, 1900 -150, 2100 -150, 2300 -150, 2400 -150 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(1)

			wkt = "LINESTRING ( 1264.63412261399 -816.1475500911281, 1246.3493739893286 -705.2200751015158, 1145.8968390998311 -629.8806739343928, 1049.8760336907526 -644.6531055357895, 993.7407936054453 -686.0159140197002, 962.7186872425123 -753.9690993861249, 987.8318209648867 -827.8312573931083, 1020.3311704879593 -861.8078500763207, 1000 -900, 924.3103650788809 -882.489254318276, 881.4703134348305 -684.5386708595605, 981.9228483243279 -579.654406489644, 1210.8955381459766 -569.3137043686663, 1324.643261476731 -631.3579170945325, 1355.665367839664 -860.3306069161811 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(1)

			wkt = "LINESTRING ( 100 -800, 100 -900, 0 -900, 0 -800, 0.2279944958968561 -732.9285667808929, 132.15239407341494 -718.6367568266617, 200 -800, 250.88435369318123 -770.3071466611897, 200 -900, 300 -900, 300 -700, 600 -700, 662.3522083102516 -834.4510759307058, 600 -900, 500 -900, 481.4875419749193 -848.8252805471226, 476.4860592642242 -729.0404143735325, 508.2690102493364 -758.6438814875202, 560.2154504813326 -809.0749601144098, 560.4781417236578 -845.2851008091432, 598.7632595356365 -846.4982672867561, 600 -800 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(5)
			g.Assert(sb.IsEven()).IsTrue()
			printPolys(sb)


			wkt = "LINESTRING ( 0.0000000000000142 -1100, 0.0000000000000142 -1200, -99.99999999999999 -1200, -99.99999999999999 -1100, -99.77200550410313 -1032.9285667808929, 32.15239407341495 -1018.6367568266617, 74.64147260840879 -1137.8320862301987, 150.88435369318123 -1070.3071466611896, 100.00000000000001 -1200, 200.00000000000003 -1200, 200.00000000000003 -1000, 500 -1000, 600 -1100, 500 -1200, 400 -1200, 381.4875419749193 -1148.8252805471227, 376.4860592642242 -1029.0404143735325, 460.2154504813326 -1109.0749601144098, 460.4781417236578 -1145.2851008091432, 498.7632595356365 -1146.4982672867561, 500 -1100 )"
			sb = SimpleBounds(loads(wkt), false)
			g.Assert(sb.RegionCount()).Equal(7)
			g.Assert(sb.IsEven()).IsTrue()
			printPolys(sb)

			//wkt = "LINESTRING ( -200 200, -200 400, 100 400, 400 300, 500 200, 200 0, -100 0, -100 300, 0 300, 0 100, 43.854064615772806 142.4893513155663, 45.08146541361937 300.6646040804819, 100 300, 100 100, 200 100, 300 200, 300 300 )"
			//sb = SBounds(loads(wkt))
			//printPolys(sb)
			//g.Assert(sb.RegionCount()).Equal(5)

		})
	})
}
func TestHomotopyOddDeformation(t *testing.T) {
	var g = goblin.Goblin(t)
	g.Describe("context homotopy case - 2", func() {
		g.It("should test odd number of intersects", func() {
			g.Timeout(1 * time.Hour)
			var wkt = "LINESTRING ( 586.1365464176768 340.48547016799586, 586.9077247835168 292.6344641285775, 604.4360595339316 263.18686174788064, 652.8142634450764 237.2449263172667, 751.674071437416 228.8313256370676, 867.3610807901538 247.7619271675156, 890.4984826607014 329.09340040944033, 876.4758148603695 392.19540551093365, 827.396477559208 420.24074111159734, 799.3511419585443 413.930540601448, 797.2477417884945 390.79313873090047, 826.6953441691915 366.25347008031974, 846.327079089656 353.63306906002106, 856.8440799399049 326.28886684937396, 849.8327460397389 298.94466463872686, 822.4885438290919 288.42766378847796, 788.8341411082954 302.45033158880983, 775.5126066979802 355.03533584005424, 761.4899388976484 381.67840466068475, 734.1457366870012 379.57500449063497, 717.318535326603 331.1968005794901, 717.318535326603 294.0367309086107, 659.1244639552258 294.0367309086107, 631.0791283545622 371.1614038104359, 650.0097298850101 447.58494332224444, 688.5720663359227 481.9404794330575, 761.4899388976484 502.9744811335553, 837.913478409457 498.06654740343913, 900.3143501209337 467.91781163272566, 931.8653526716803 420.24074111159734, 947.2902872520453 370.4602704204193, 947.4987309748076 338.3020128594936 )"
			var coordinates = loads(wkt)
			var sb = SimpleBounds(coordinates, false)
			g.Assert(sb.RegionCount()).Equal(2)
			g.Assert(sb.IsOdd()).IsTrue()

			sb = SimpleBounds(coordinates, true, sb)
			g.Assert(sb.RegionCount()).Equal(2)
			g.Assert(sb.IsOdd()).IsTrue()

			wkt = "LINESTRING ( -200 200, -200 400, 100 400, 400 300, 500 200, 200 0, -100 0, -100 300, 0 300, 0 100, 43.854064615772806 142.4893513155663, 45.08146541361937 300.6646040804819, 100 300, 100 100, 200 100, 300 200, 300 300 )"
			coordinates = loads(wkt)
			sb = SimpleBounds(coordinates, false)
			g.Assert(sb.RegionCount()).Equal(2)
			g.Assert(sb.IsOdd()).IsTrue()

			sb = SimpleBounds(coordinates, true, sb)
			g.Assert(sb.RegionCount()).Equal(2)
			g.Assert(sb.IsOdd()).IsTrue()

			wkt = "LINESTRING ( 800 -400, 840.0021638548561 -355.1442890183745, 838.9770190849463 -276.20814173531585, 911.7622977485457 -211.62402123099514, 1070.6597370845727 -189.0708362929784, 1173.2829374993098 -215.59072092640855, 1209.6229881620284 -276.5482252638715, 1243.6185194271518 -338.67798930013174, 1245.376908975348 -440.66458309550234, 1136.2690023588032 -466.88506893854833, 1024.5282224386294 -475.08622709782713, 959.8953249291841 -436.02696050261244, 939.1999511343239 -369.04011688525804, 945.5920751555708 -315.16364299189024, 996.8493136510634 -289.5350237441439, 1069.6345923146628 -281.3338655848651, 1138.3192918986229 -302.861905752972, 1175.6274568969047 -342.7808982459225, 1200 -400 )"
			sb = SimpleBounds(coordinates, false)
			g.Assert(sb.RegionCount()).Equal(2)
			g.Assert(sb.IsOdd()).IsTrue()


			//sb = SimpleBounds(coordinates, true, sb)
			//g.Assert(sb.RegionCount()).Equal(2)
			//g.Assert(sb.IsOdd()).IsTrue()
			//printPolys(sb)
		})
	})
}
